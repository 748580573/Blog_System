<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="blogTag">

    <!--#####################用于博客内容展示#################################-->
    <resultMap id="blogMapForShow" type="com.heng.blog_system.bean.Blog">
        <result property="blogCode" column="blog_code"/>
        <result property="blogTilte" column="blog_title"/>
        <result property="blogDesc" column="blog_desc"/>
        <result property="blogContent" column="blog_content"/>
        <result property="blogConverUrl" column="blog_conver_url"/>
        <result property="tags" column="tag_name"/>
        <result property="createDate" column="create_date"/>
    </resultMap>

    <!--###################用于首页###############################-->
    <resultMap id="blogMapForIndex" type="com.heng.blog_system.bean.Blog">
        <result property="blogCode" column="blog_code"/>
        <result property="blogTilte" column="blog_title"/>
        <result property="blogDesc" column="blog_desc"/>
        <result property="blogConverUrl" column="blog_conver_url"/>
        <result property="tags" column="tag_name"/>
        <result property="createDate" column="create_date"/>
    </resultMap>



    <insert id="addBlog" parameterType="map">
        INSERT INTO blog_article(blog_code,blog_title,blog_desc,blog_content,blog_conver_url,create_date)
        VALUES (#{blog_code},#{blog_title},#{blog_desc},#{blog_content},#{imgUrl},#{create_date});
    </insert>

    <!--用于首页-->
    <select id="selectBlogForIndex" parameterType="map" resultMap="blogMapForIndex">
        SELECT
        *
        FROM
        blog_article,
        (
        SELECT
        GROUP_CONCAT( DISTINCT tags.tag_name ) tag_name ,blog_article.blog_code
        FROM
        blog_article,
        tag_article,
        tags
        WHERE
        tag_article.blog_code = blog_article.blog_code
        AND tags.tag_code = tag_article.tag_code
        <if test="blog_code != null">
            AND tag_article.blog_code = "${blog_code}"
        </if>
        GROUP BY tag_article.blog_code
        ) tagresult
        WHERE tagresult.blog_code = blog_article.blog_code
    </select>

    <!--用于博客展示-->
    <select id="selectBlogForShow" parameterType="map" resultMap="blogMapForShow">
        SELECT
        *
        FROM
        blog_article,
        (
        SELECT
        GROUP_CONCAT( DISTINCT tags.tag_name ) tag_name ,blog_article.blog_code
        FROM
        blog_article,
        tag_article,
        tags
        WHERE
        tag_article.blog_code = blog_article.blog_code
        AND tags.tag_code = tag_article.tag_code
        <if test="blog_code != null">
            AND tag_article.blog_code = "${blog_code}"
        </if>
        GROUP BY tag_article.blog_code
        ) tagresult
        WHERE tagresult.blog_code = blog_article.blog_code
    </select>

    <select id="selectBlogForSearch" parameterType="map" resultMap="blogMapForIndex">
        SELECT
        *
        FROM
        blog_article,
        (
        SELECT
        GROUP_CONCAT( DISTINCT tags.tag_name ) tag_name ,blog_article.blog_code
        FROM
        blog_article,
        tag_article,
        tags
        WHERE
        tag_article.blog_code = blog_article.blog_code
        AND tags.tag_code = tag_article.tag_code
        <if test="blog_code != null">
            AND tag_article.blog_code = "${blog_code}"
        </if>
        GROUP BY tag_article.blog_code
        ) tagresult
        WHERE tagresult.blog_code = blog_article.blog_code
        <if test="start != null">
            and create_date &gt;= #{start}
        </if>
        <if test="end != null">
            and create_date &lt;= #{end}
        </if>
        <if test="blogTitle != null">
            and blog_title like "%${blogTitle}%"
        </if>
        <if test="orderKey != null">
            ORDER BY #{orderKey}
        </if>
        <if test="pageNumber != null">
            limit ${(pageNumber - 1) * pageSize} ,${pageSize}
        </if>
    </select>

    <select id="selectBlogForRecommend" parameterType="map" resultMap="blogMapForIndex">
        SELECT
        *
        FROM
        blog_article,
        (
        SELECT
        GROUP_CONCAT( DISTINCT tags.tag_name ) tag_name ,blog_article.blog_code
        FROM
        blog_article,
        tag_article,
        tags
        WHERE
        tag_article.blog_code = blog_article.blog_code
        AND tags.tag_code = tag_article.tag_code
        GROUP BY tag_article.blog_code
        ) tagresult
        WHERE tagresult.blog_code = blog_article.blog_code
        ORDER BY click_number,create_date DESC
        <if test="pageNumber != null">
            limit ${(pageNumber - 1) * pageSize} ,${pageNumber * pageSize}
        </if>
    </select>

    <select id="selectBlogForRank" resultMap="blogMapForIndex" parameterType="map">
        SELECT *
        FROM blog_article
        ORDER BY click_number,create_date DESC
        <if test="pageNumber != null">
            limit ${(pageNumber - 1) * pageSize} ,${pageNumber * pageSize}
        </if>
    </select>

    <select id="selectBlogTotal" resultType="int">
        SELECT count(blog_code)
        FROM blog_article
        WHERE 1 = 1
        <if test="start != null">
            and create_date &gt;= #{start}
        </if>
        <if test="end != null">
            and create_date &lt;= #{end}
        </if>
        <if test="blogTitle != null">
            and blog_title like "%${blogTitle}%"
        </if>
        ;
    </select>

    <update id="updateBlog" parameterType="map">
        UPDATE blog_article
        <trim prefix="set" suffixOverrides=",">
            <if test="blog_desc != null">blog_desc = #{blog_desc},</if>
            <if test="blog_desc != null"> blog_conver_url = #{imgUrl},</if>
            <if test="blog_content">blog_content = #{blog_content},</if>
        </trim>
        WHERE  blog_code = #{blog_code}
    </update>

    <delete id="deleteBlog" parameterType="map">
        DELETE FROM blog_article WHERE blog_code = #{blog_code};
    </delete>

    <!--##################################Tag############################################-->

    <resultMap id="tagMap" type="com.heng.blog_system.bean.Tag">
        <result property="tagCode" column="tag_code"/>
        <result property="tagName" column="tag_name"/>
    </resultMap>

    <insert id="addTag" parameterType="map">
        INSERT INTO tags(tag_code,tag_name)
        VALUES (#{tag_code},#{tag_name})
    </insert>

    <select id="selectTag" resultMap="tagMap" parameterType="map">
        SELECT *
        FROM tags
        WHERE 1 = 1
        <if test="tag_code != null">
            AND tag_code = #{tag_code}
        </if>
    </select>

    <select id="selectAllTag" resultMap="tagMap">
        SELECT DISTINCT(tags.tag_name) FROM tags;
    </select>

    <select id="selecTagsByBlog" parameterType="map" resultType="String">
        SELECT
        GROUP_CONCAT( DISTINCT tags.tag_name ) tag_name
        FROM
        blog_article,
        tag_article,
        tags
        WHERE
        tag_article.blog_code = blog_article.blog_code
        AND tags.tag_code = tag_article.tag_code
        <if test="blog_code != null">
            AND tag_article.blog_code = "${blog_code}"
        </if>
        GROUP BY tag_article.blog_code
    </select>

    <!--################################标签-博客关联表################################################-->

    <insert id="insertTagBlog" parameterType="map">
          insert into tag_article(blog_code,tag_code) values (#{blog_code},#{tag_code})
    </insert>
    <delete id="deleteTagBlog" parameterType="map">
        DELETE FROM tag_article WHERE  blog_code = #{blog_code};
    </delete>
</mapper>

